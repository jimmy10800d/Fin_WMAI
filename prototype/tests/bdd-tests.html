<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è–ªå®ˆæ‘ â€” BDD å‰ç«¯æ¸¬è©¦</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans TC', sans-serif; background: #1a1a2e; color: #e0e0e0; padding: 20px; }
    h1 { color: #d4a843; margin-bottom: 20px; }
    .test-suite { margin-bottom: 24px; }
    .suite-title { font-size: 1rem; font-weight: 700; color: #4a90d9; margin-bottom: 8px; padding: 8px 12px; background: rgba(74,144,217,0.1); border-radius: 6px; }
    .test-item { display: flex; align-items: center; gap: 8px; padding: 6px 12px; font-size: 0.85rem; }
    .test-item.pass { color: #4a7c59; }
    .test-item.fail { color: #c0392b; }
    .test-item.pending { color: #7f8c8d; }
    .status { font-size: 1rem; }
    .summary { margin-top: 20px; padding: 16px; background: rgba(212,168,67,0.1); border: 1px solid rgba(212,168,67,0.3); border-radius: 8px; font-size: 1rem; }
    .summary.all-pass { border-color: #4a7c59; background: rgba(74,124,89,0.1); }
    .summary.has-fail { border-color: #c0392b; background: rgba(192,57,43,0.1); }
    button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; }
    .btn-run { background: #d4a843; color: #1a1a2e; margin-bottom: 16px; }
    .btn-run:hover { background: #c5993d; }
    #logArea { margin-top: 16px; padding: 12px; background: #0d0d1a; border-radius: 6px; font-family: monospace; font-size: 0.78rem; max-height: 300px; overflow-y: auto; white-space: pre-wrap; color: #aaa; }
  </style>
</head>
<body>
  <h1>ğŸ§ª è–ªå®ˆæ‘ BDD å‰ç«¯æ¸¬è©¦</h1>
  <button class="btn-run" onclick="runBDDTests()">â–¶ åŸ·è¡Œå…¨éƒ¨æ¸¬è©¦</button>
  <div id="testResults"></div>
  <div id="summary"></div>
  <div id="logArea"></div>

  <script>
    let totalPass = 0, totalFail = 0;
    const container = document.getElementById('testResults');
    const summaryEl = document.getElementById('summary');
    const logArea = document.getElementById('logArea');

    function log(msg) { logArea.textContent += msg + '\n'; logArea.scrollTop = logArea.scrollHeight; }

    function suite(name) {
      const div = document.createElement('div');
      div.className = 'test-suite';
      div.innerHTML = `<div class="suite-title">${name}</div>`;
      container.appendChild(div);
      return div;
    }

    function test(suiteDiv, name, fn) {
      const item = document.createElement('div');
      item.className = 'test-item pending';
      item.innerHTML = `<span class="status">â³</span> ${name}`;
      suiteDiv.appendChild(item);
      try {
        const result = fn();
        if (result === true) {
          item.className = 'test-item pass';
          item.innerHTML = `<span class="status">âœ…</span> ${name}`;
          totalPass++;
        } else {
          item.className = 'test-item fail';
          item.innerHTML = `<span class="status">âŒ</span> ${name} â€” ${result || 'FAIL'}`;
          totalFail++;
          log(`FAIL: ${name} â€” ${result}`);
        }
      } catch (e) {
        item.className = 'test-item fail';
        item.innerHTML = `<span class="status">âŒ</span> ${name} â€” Error: ${e.message}`;
        totalFail++;
        log(`ERROR: ${name} â€” ${e.message}`);
      }
    }

    function updateSummary() {
      const total = totalPass + totalFail;
      const allPass = totalFail === 0;
      summaryEl.className = `summary ${allPass ? 'all-pass' : 'has-fail'}`;
      summaryEl.innerHTML = allPass
        ? `âœ… å…¨éƒ¨ ${total} é …æ¸¬è©¦é€šéï¼`
        : `âš ï¸ ${totalPass} é€šé / ${totalFail} å¤±æ•— / å…± ${total} é …`;
    }

    function runBDDTests() {
      totalPass = 0; totalFail = 0;
      container.innerHTML = ''; summaryEl.innerHTML = ''; logArea.textContent = '';
      log('ğŸ§ª BDD å‰ç«¯æ¸¬è©¦é–‹å§‹...\n');

      // --- Feature A: ç›®æ¨™è¨­å®š ---
      const sA = suite('Feature A: åˆå¿ƒè€…ç›®æ¨™è¨­å®š');
      test(sA, 'GoalTypes æ‡‰æœ‰ 8 ç¨®ç›®æ¨™é¡å‹', () => {
        return typeof GoalTypes !== 'undefined' && GoalTypes.length === 8 ? true : `found ${typeof GoalTypes !== 'undefined' ? GoalTypes.length : 0}`;
      });
      test(sA, 'renderGoalsPage æ‡‰ç‚ºå‡½å¼', () => typeof renderGoalsPage === 'function' ? true : 'not a function');
      test(sA, 'isFuzzyInput æ‡‰åµæ¸¬ã€Œä¸çŸ¥é“ã€ç‚ºæ¨¡ç³Š', () => {
        if (typeof isFuzzyInput !== 'function') return 'isFuzzyInput not defined';
        return isFuzzyInput({ type: 'custom', amount: 100, years: 5, monthly: 5000, description: 'ä¸çŸ¥é“' }) === true ? true : 'not detected';
      });
      test(sA, 'isFuzzyInput æ‡‰é€šéæ­£å¸¸è¼¸å…¥', () => {
        if (typeof isFuzzyInput !== 'function') return 'isFuzzyInput not defined';
        return isFuzzyInput({ type: 'retirement', amount: 5000000, years: 25, monthly: 15000, description: '60æ­²é€€ä¼‘' }) === false ? true : 'false positive';
      });

      // --- Feature B: KYC/Profile ---
      const sB = suite('Feature B: è·æ¥­èªªæ˜ NPCï¼ˆKYCï¼‰');
      test(sB, 'renderProfilePage æ‡‰ç‚ºå‡½å¼', () => typeof renderProfilePage === 'function' ? true : 'not a function');
      test(sB, 'API.submitKYC æ‡‰ç‚ºå‡½å¼', () => typeof API?.submitKYC === 'function' ? true : 'not a function');

      // --- Feature C-E: Recommendation ---
      const sCE = suite('Feature C-E: å°ˆå±¬ç‰¹æ®ŠæŠ€èƒ½ï¼ˆæ–¹æ¡ˆæ¨è–¦ï¼‰');
      test(sCE, 'ExplainStrategies æ‡‰æœ‰ 4 ç¨®èªªæ˜æ¨¡å¼', () => {
        return typeof ExplainStrategies !== 'undefined' && Object.keys(ExplainStrategies).length === 4 ? true : `found ${typeof ExplainStrategies !== 'undefined' ? Object.keys(ExplainStrategies).length : 0}`;
      });
      test(sCE, 'renderRecommendationPage æ‡‰ç‚ºå‡½å¼', () => typeof renderRecommendationPage === 'function' ? true : 'not a function');
      test(sCE, 'switchExplainStrategy æ‡‰ç‚ºå‡½å¼', () => typeof switchExplainStrategy === 'function' ? true : 'not a function');
      test(sCE, 'recState æ‡‰è¿½è¹¤ explainRetryCount', () => {
        return typeof recState !== 'undefined' && 'explainRetryCount' in recState ? true : 'explainRetryCount not found';
      });

      // --- Feature F-G: Execution ---
      const sFG = suite('Feature F-G: æ”»å…‹æ“šé»ï¼ˆä¸€éµä¸‹å–®ï¼‰');
      test(sFG, 'renderExecutionPage æ‡‰ç‚ºå‡½å¼', () => typeof renderExecutionPage === 'function' ? true : 'not a function');
      test(sFG, 'API.pretradeCheck æ‡‰ç‚ºå‡½å¼', () => typeof API?.pretradeCheck === 'function' ? true : 'not a function');
      test(sFG, 'API.submitOrder æ‡‰ç‚ºå‡½å¼', () => typeof API?.submitOrder === 'function' ? true : 'not a function');

      // --- Feature I: Trust Thermometer ---
      const sI = suite('Feature I: ä¿¡ä»»æº«åº¦è¨ˆ');
      test(sI, 'setTrust æ‡‰ç‚ºå‡½å¼', () => typeof setTrust === 'function' ? true : 'not a function');

      // --- Feature J-M: Allies ---
      const sJM = suite('Feature J-M: ç›Ÿå‹ç³»çµ±');
      test(sJM, 'renderAlliesPage æ‡‰ç‚ºå‡½å¼', () => typeof renderAlliesPage === 'function' ? true : 'not a function');
      test(sJM, 'switchAlliesTab æ‡‰ç‚ºå‡½å¼', () => typeof switchAlliesTab === 'function' ? true : 'not a function');
      test(sJM, 'generateInvite æ‡‰ç‚ºå‡½å¼', () => typeof generateInvite === 'function' ? true : 'not a function');
      test(sJM, 'sendEncourage æ‡‰ç‚ºå‡½å¼', () => typeof sendEncourage === 'function' ? true : 'not a function');
      test(sJM, 'createChallenge æ‡‰ç‚ºå‡½å¼', () => typeof createChallenge === 'function' ? true : 'not a function');

      // --- Feature N: Share ---
      const sN = suite('Feature N: å†’éšªæ—¥èªŒåˆ†äº«');
      test(sN, 'renderSharePage æ‡‰ç‚ºå‡½å¼', () => typeof renderSharePage === 'function' ? true : 'not a function');
      test(sN, 'renderShareToAllySection æ‡‰ç‚ºå‡½å¼', () => typeof renderShareToAllySection === 'function' ? true : 'not a function');

      // --- Feature O: Rank/Star System ---
      const sO = suite('Feature O: ä¸»è§’ç­‰ç´šç³»çµ±');
      test(sO, 'RANK_NAMES æ‡‰æœ‰ 6 å€‹éšç´š', () => {
        return typeof RANK_NAMES !== 'undefined' && Object.keys(RANK_NAMES).length === 6 ? true : `found ${typeof RANK_NAMES !== 'undefined' ? Object.keys(RANK_NAMES).length : 0}`;
      });
      test(sO, 'RANK_XP_PER_STAR æ‡‰æœ‰ 6 å€‹éšç´šå®šç¾©', () => {
        return typeof RANK_XP_PER_STAR !== 'undefined' && Object.keys(RANK_XP_PER_STAR).length === 6 ? true : 'missing';
      });
      test(sO, 'AppState æ‡‰æœ‰ rank å’Œ stars å±¬æ€§', () => {
        return typeof AppState !== 'undefined' && 'rank' in AppState && 'stars' in AppState ? true : 'missing';
      });
      test(sO, 'checkXPLimit æ‡‰ç‚ºå‡½å¼', () => typeof checkXPLimit === 'function' ? true : 'not a function');
      test(sO, 'XP_TABLE æ‡‰æœ‰è‡³å°‘ 15 ç¨®äº‹ä»¶', () => {
        return typeof XP_TABLE !== 'undefined' && Object.keys(XP_TABLE).length >= 15 ? true : `found ${typeof XP_TABLE !== 'undefined' ? Object.keys(XP_TABLE).length : 0}`;
      });
      test(sO, 'addXP æ‡‰ç‚ºå‡½å¼', () => typeof addXP === 'function' ? true : 'not a function');

      // --- Feature P: Unlock Map ---
      const sP = suite('Feature P: åŠŸèƒ½è§£é–');
      test(sP, 'UNLOCK_MAP æ‡‰å®šç¾© R2-R6 è§£é–å…§å®¹', () => {
        if (typeof UNLOCK_MAP === 'undefined') return 'UNLOCK_MAP not defined';
        const keys = Object.keys(UNLOCK_MAP).map(Number);
        return keys.includes(2) && keys.includes(3) && keys.includes(6) ? true : `keys: ${keys}`;
      });
      test(sP, 'R3 æ‡‰è§£é–ç›Ÿå‹ç³»çµ±', () => {
        if (typeof UNLOCK_MAP === 'undefined') return 'UNLOCK_MAP not defined';
        const r3 = UNLOCK_MAP[3] || [];
        return r3.some(u => u.feature === 'allies_full') ? true : 'allies_full not in R3';
      });

      // --- Core Engine ---
      const sCore = suite('Core: éŠæˆ²å¼•æ“');
      test(sCore, 'navigateTo æ‡‰ç‚ºå‡½å¼', () => typeof navigateTo === 'function' ? true : 'not a function');
      test(sCore, 'logEvent æ‡‰ç‚ºå‡½å¼', () => typeof logEvent === 'function' ? true : 'not a function');
      test(sCore, 'logEventRaw æ‡‰ç‚ºå‡½å¼', () => typeof logEventRaw === 'function' ? true : 'not a function');
      test(sCore, 'showToast æ‡‰ç‚ºå‡½å¼', () => typeof showToast === 'function' ? true : 'not a function');
      test(sCore, 'unlockQuest æ‡‰ç‚ºå‡½å¼', () => typeof unlockQuest === 'function' ? true : 'not a function');
      test(sCore, 'completeQuest æ‡‰ç‚ºå‡½å¼', () => typeof completeQuest === 'function' ? true : 'not a function');
      test(sCore, 'Demo.runSmokeTest æ‡‰ç‚ºå‡½å¼', () => typeof Demo?.runSmokeTest === 'function' ? true : 'not a function');
      test(sCore, 'AppState.questStatus æ‡‰åŒ…å« allies', () => {
        return typeof AppState !== 'undefined' && 'allies' in AppState.questStatus ? true : 'allies not in questStatus';
      });

      // --- Demo Helper ---
      const sDemo = suite('Demo: æ¸¬è©¦è¼”åŠ©');
      test(sDemo, 'Demo.quickSetup æ‡‰ç‚ºå‡½å¼', () => typeof Demo?.quickSetup === 'function' ? true : 'not a function');
      test(sDemo, 'Demo.reset æ‡‰ç‚ºå‡½å¼', () => typeof Demo?.reset === 'function' ? true : 'not a function');

      updateSummary();
      log(`\nçµæœï¼š${totalPass} é€šé / ${totalFail} å¤±æ•—`);
    }
  </script>

  <!-- Load all app scripts to test -->
  <script>
    // Mock sessionStorage for testing
    sessionStorage.setItem('isLoggedIn', 'true');
    sessionStorage.setItem('currentUser', JSON.stringify({ name: 'æ¸¬è©¦è€…', level: 1 }));
  </script>
  <script src="../js/data-service.js"></script>
  <script src="../js/app.js"></script>
  <script src="../js/pages/home.js"></script>
  <script src="../js/pages/goals.js"></script>
  <script src="../js/pages/profile.js"></script>
  <script src="../js/pages/recommendation.js"></script>
  <script src="../js/pages/execution.js"></script>
  <script src="../js/pages/dashboard.js"></script>
  <script src="../js/pages/share.js"></script>
  <script src="../js/pages/allies.js"></script>
  <script src="../js/demo.js"></script>
</body>
</html>
